<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>4채널 CCTV YOLO 시스템</title>
  <style>
   html, body {
      margin: 0; 
      height: 100vh; 
      background-color: #111;
      color: white; 
      font-family: sans-serif; 
      overflow: hidden;
      display: flex;                 /* 아래쪽 요소를 위아래로 쌓기 */
      flex-direction: column;
    }
    .top-bar {
      background: #222; padding: 10px 20px; display: flex; justify-content: space-between;
      align-items: center; border-bottom: 2px solid #444;
    }
    .main-content { 
        display: flex; 
        overflow: hidden;
        transition: margin-right 0.3s ease; 
        flex-direction: column;
        flex: 1;
    }

    .main-content.sidebar-open { margin-right: 300px; }

    .main-content.bottom-open {
         margin-bottom: 175px;
    }
    /* 이 아래에 추가 */
    .main-content.bottom-open .video-area {
      height: calc(100% - 300px);
    }
    
    
    .video-area {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 6px;
      padding: 6px;
      height: 100%;
      transition: height 0.3s ease;
    }

    .video-area.alt-expanded {
      grid-template-columns: 2fr 1fr;
      grid-template-rows: 1fr 1fr 1fr;
    }

    .cam-container {
      position: relative; text-align: center; height: 100%; overflow: hidden;
      border: 2px solid #444; box-sizing: border-box;
    }

    .cam-container img {
      width: 100%; height: 100%; object-fit: cover; cursor: pointer;
    }

    .cam-container.expanded {
      grid-column: 1 / 2;
      grid-row: 1 / 4;
    }

    .cam-container.right-small {
      grid-row: 2;
    }

    .timestamp {
      position: absolute;
      top: 8px;
      left: 8px;
      font-size: 14px;
      color: white;
      font-family: 'Courier New', monospace;
      font-weight: bold;
      text-shadow: 0 0 4px black;
    }

    .mode-switch {
      position: absolute;
      bottom: 8px;
      left: 8px;
      display: flex;
      gap: 6px;
    }

    .mode-switch button {
      background: #444; color: white; border: none;
      padding: 4px 8px; border-radius: 4px; cursor: pointer;
    }

    .mode-switch button:hover {
      background: #666;
    }

    .sidebar {
      position: absolute;
      top: 50px;
      right: 0;
      width: 300px;
      height: calc(100vh - 50px);
      background-color: #222;
      border-left: 2px solid #444;
      padding: 10px;
      overflow-y: auto;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      z-index: 999;
    }

    .sidebar.open { transform: translateX(0); }

    .log-entry {
      background-color: #333;
      border: 1px solid #555;
      border-radius: 5px;
      padding: 8px;
      margin: 5px 0;
      cursor: pointer;
    }

    .floating-player {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #000;
      border: 2px solid white;
      border-radius: 8px;
      overflow: hidden;
      z-index: 999;
      min-width: 200px;
      min-height: 150px;
      max-width: 90vw;
      max-height: 90vh;
      box-sizing: border-box;
      cursor: grab;
      width: 400px;
      height: 225px;
      
    }

    .floating-player.dragging {
      opacity: 0.85;
      cursor:  grabbing;
    }

    .floating-player video {
       width: 100%;
       height: 100%;
       display: block;
       object-fit: contain;
       transform-origin: center center;
    }

    .cam-container.alert-border {
      animation: blink-border 1s infinite;
      border: 4px solid red;
    }

    @keyframes blink-border {
      0% { border-color: red; }
      50% { border-color: white; }
      100% { border-color: red; }
    }

     .cam-container.alert-border-green {
      animation: blink-border-green 1s infinite;
      border: 4px solid limegreen;
    }

    @keyframes blink-border-green {
      0% { border-color: limegreen; }
      50% { border-color: white; }
      100% { border-color: limegreen; }
    }

    .bottom-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 150px;
    background-color: #222;
    border-top: 2px solid #444;
    overflow-y: auto;
    transform: translateY(100%);
    transition: transform 0.3s ease;
    z-index: 998;
    padding: 10px;
  }

  .bottom-bar.open {
    transform: translateY(0);
  }
  </style>
</head>
<body>
  <div id="alert-banner" style="display: none; position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
    background-color: red; color: white; padding: 10px 20px; text-align: center;
    font-weight: bold; z-index: 9999; border-radius: 8px;">
    🚨 감지: <span id="alert-label"></span> (카메라: <span id="alert-cam"></span>)
    <button onclick="acknowledgeWarning()" style="margin-left: 10px; background: white; color: red;
      padding: 4px 8px; border-radius: 4px; border: none; cursor: pointer;">확인</button>
  </div>

  <div class="top-bar">
    <div><strong> O0소초 상황실</strong></div>
    <div class="right-buttons">
    <button onclick="toggleSidebar()">📋 탐지 로그</button>
    <button onclick="toggleBottomBar()">⬆️ 하단 로그</button>
    </div>
</div>


  <div class="main-content" id="main">
  <div class="video-area">
    {% for i in range(1, 5) %}
    <div class="cam-container">
      <img id="cam{{ i }}" src="/stream/cam{{ i }}?mode=rgb">
      <div class="timestamp" id="timestamp{{ i }}"></div>
      <div class="mode-switch">
        <button onclick="toggleMode('cam{{ i }}', this)"> 채널전환</button>
      </div>
    </div>
    {% endfor %}
  </div>
</div>


  <div class="sidebar" id="sidebar">
    <h3>🚨 감지 로그</h3>
    <div id="log-list"></div>
  </div>

  <div class="floating-player" id="clip-player" style="display:none">
  <button onclick="closeClipPlayer()" style="
    position:absolute;
    top:4px;
    right:4px;
    background:#fff;
    color:#000;
    border:none;
    border-radius:4px;
    padding:2px 6px;
    font-size:16px;
    cursor:pointer;
    z-index:1000;
  ">×</button>
  <video id="player-video" controls></video>
</div>

   <script>
    function switchMode(camId, mode) {
      const img = document.getElementById(camId);
      img.src = `/stream/${camId}?mode=${mode}`;
    }

    async function loadLogs() {
      const res = await fetch('/logs');
      const logs = await res.json();
      const container = document.getElementById('log-list');

      // 현재 존재하는 로그 key를 기록
      const existingKeys = new Set();
      container.querySelectorAll('.log-entry').forEach(entry => {
        const key = entry.getAttribute('data-key');
        if (key) existingKeys.add(key);
      });

      logs.reverse().forEach(log => {
        const key = `${log.cam}_${log.label}_${log.time}`;
        if (existingKeys.has(key)) return;

        const div = document.createElement('div');
        div.className = 'log-entry';
        div.setAttribute('data-key', key);
        const label = log.label === 'animal' ? '🐾 animal' : '🚶 person';
        div.innerHTML = `<div><strong>${log.cam}</strong></div><div>${label}</div><div style="font-size: 12px; color: #aaa;">${log.time}</div>`;
        div.onclick = () => {
            console.log("🖱️ 로그 클릭됨:", log);
            playClip(log.clip);
        };
        container.appendChild(div);
      });
    }

    function enableFloatingPlayerDrag() {
  const player = document.getElementById('clip-player');
  let isDragging = false;
  let offsetX, offsetY;

  player.addEventListener('mousedown', (e) => {
    // 닫기 버튼 누른 경우 제외
    if (e.target.tagName === 'BUTTON') return;

    isDragging = true;
    offsetX = e.clientX - player.getBoundingClientRect().left;
    offsetY = e.clientY - player.getBoundingClientRect().top;
    player.classList.add('dragging');
  });

  document.addEventListener('mouseup', () => {
    isDragging = false;
    player.classList.remove('dragging');
  });

  document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    const x = e.clientX - offsetX;
    const y = e.clientY - offsetY;
    player.style.left = `${x}px`;
    player.style.top = `${y}px`;
    player.style.right = 'auto';
    player.style.bottom = 'auto';
  });
}

    function enableFloatingPlayerDragAndZoom() {
  const player = document.getElementById('clip-player');
  const video = document.getElementById('player-video');

  let isDragging = false;
  let offsetX = 0;
  let offsetY = 0;
  let scale = 1;

  // 좌클릭 드래그로 이동
  player.addEventListener('mousedown', (e) => {
    // 닫기 버튼은 제외
    if (e.target.tagName === 'BUTTON') return;
    e.preventDefault();

    isDragging = true;
    offsetX = e.clientX - player.getBoundingClientRect().left;
    offsetY = e.clientY - player.getBoundingClientRect().top;
    player.classList.add('dragging');
  });

  document.addEventListener('mouseup', () => {
    isDragging = false;
    player.classList.remove('dragging');
  });

  document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;

    const x = e.clientX - offsetX;
    const y = e.clientY - offsetY;

    player.style.left = `${x}px`;
    player.style.top = `${y}px`;
    player.style.right = 'auto';
    player.style.bottom = 'auto';
  });

  // Ctrl + 휠로 확대/축소
  player.addEventListener('wheel', (e) => {
    if (!e.ctrlKey) return;

    e.preventDefault();
    const delta = e.deltaY < 0 ? 0.1 : -0.1;
    scale = Math.min(Math.max(0.5, scale + delta), 3);
    video.style.transform = `scale(${scale})`;
  });
}
    
    function enableFloatingPlayerDragAndResize() {
  const player = document.getElementById('clip-player');
  const video = document.getElementById('player-video');

  let isDragging = false;
  let isResizing = false;
  let startX, startY;
  let startWidth, startHeight;
  let offsetX, offsetY;

  player.addEventListener('mousedown', (e) => {
    e.preventDefault();
    if (e.target.tagName === 'BUTTON') return;

    const rect = player.getBoundingClientRect();

    if (e.ctrlKey) {
      // ✅ Ctrl 키 눌렀으면 크기 조절 모드
      isResizing = true;
      startX = e.clientX;
      startY = e.clientY;
      startWidth = rect.width;
      startHeight = rect.height;
    } else {
      // ✅ 기본은 위치 이동 모드
      isDragging = true;
      offsetX = e.clientX - rect.left;
      offsetY = e.clientY - rect.top;
      player.classList.add('dragging');
    }
  });

  document.addEventListener('mousemove', (e) => {
    if (isDragging) {
      const x = e.clientX - offsetX;
      const y = e.clientY - offsetY;
      player.style.left = `${x}px`;
      player.style.top = `${y}px`;
      player.style.right = 'auto';
      player.style.bottom = 'auto';
    }

    if (isResizing) {
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      player.style.width = `${Math.max(200, startWidth + dx)}px`;
      player.style.height = `${Math.max(150, startHeight + dy)}px`;
    }
  });

  document.addEventListener('mouseup', () => {
    isDragging = false;
    isResizing = false;
    player.classList.remove('dragging');
  });
}

    



    function playClip(path) {
      const player = document.getElementById('clip-player');
      const video = document.getElementById('player-video');
      video.src = path;
      player.style.display = 'block';
      video.play();
    }

    function closeClipPlayer() {
      const player = document.getElementById('clip-player');
      const video = document.getElementById('player-video');
      video.pause();
      player.style.display = 'none';
    }

    function updateTimestamps() {
      const now = new Date();
      const formatted = now.toLocaleString('sv-SE');
      for (let i = 1; i <= 4; i++) {
        document.getElementById('timestamp' + i).textContent = `CAM${i} - ${formatted}`;
      }
    }

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const main = document.getElementById('main');
      const isOpen = sidebar.classList.contains('open');
      sidebar.classList.toggle('open');
      main.classList.toggle('sidebar-open');
      if (!isOpen) loadLogs();
    }

    function toggleBottomBar() {
      const bar = document.getElementById('bottomBar');
      const main = document.getElementById('main');
      const isOpen = bar.classList.contains('open');

     bar.classList.toggle('open');
     main.classList.toggle('bottom-open');
   }

    async function pollWarning() {
  try {
    const res = await fetch('/current-warning');
    const result = await res.json();
    const banner = document.getElementById('alert-banner');

    const entries = Object.entries(result.warnings || {}).filter(([_, val]) => val !== null);
    if (entries.length > 0) {
      const [cam, info] = entries[0];
      const isAnimal = info.label === 'animal';

      document.getElementById('alert-label').innerText = isAnimal ? '동물' : '사람';
      document.getElementById('alert-cam').innerText = cam.replace('_rgb', '').replace('_thermal', '');


      // 배너 스타일 변경
      banner.style.backgroundColor = isAnimal ? 'green' : 'red';
      banner.style.color = 'white';
      banner.style.display = 'block';
      banner.setAttribute('data-cam', cam);

      
      const personSound = document.getElementById('alert-sound-person');
      const animalSound = document.getElementById('alert-sound-animal');
      if (isAnimal) {
        if (animalSound.paused) {
           animalSound.play()
             .then(() => console.log("🐾 동물 경고음 재생됨"))
             .catch(err => console.warn("🔇 동물 소리 자동재생 차단:", err));
     }
      } else {
         if (personSound.paused) {
           personSound.play()
             .then(() => console.log("🚨 사람 경고음 재생됨"))
             .catch(err => console.warn("🔇 사람 소리 자동재생 차단:", err));
          }
       }
      // 테두리 강조 (label도 함께 전달)
      highlightCamera(cam, info.label);
    } else {
      banner.style.display = 'none';
      highlightCamera(null);
    }
  } catch (err) {
    console.error('⚠ 워닝 상태 확인 실패:', err);
  }
}


    function acknowledgeWarning() {
  const cam = document.getElementById('alert-banner').getAttribute('data-cam');

  fetch(`/clear_warning/${cam}`, { method: 'POST' }).then(() => {
    document.getElementById('alert-banner').style.display = 'none';
    highlightCamera(null);

    // ✅ 경고음 정지
    const personSound = document.getElementById('alert-sound-person');
    const animalSound = document.getElementById('alert-sound-animal');

    personSound.pause();
    personSound.currentTime = 0;

    animalSound.pause();
    animalSound.currentTime = 0;

  });
}

    function highlightCamera(name, label = 'person') {
      for (let i = 1; i <= 4; i++) {
        const container = document.getElementById('cam' + i).closest('.cam-container');
        container.classList.remove('alert-border', 'alert-border-green');
    }

    if (name) {
      const match = name.match(/\d+/);
       if (match) {
         const num = match[0];
         const container = document.getElementById('cam' + num).closest('.cam-container');
         if (label === 'animal') {
           container.classList.add('alert-border-green');
         } else {
            container.classList.add('alert-border');
         }
        }
      }
    }  


    function enablePanZoom(img) {
      let scale = 1, posX = 0, posY = 0;
      let isDragging = false, startX, startY;

      img.addEventListener('wheel', e => {
        if (!e.ctrlKey) return;
        e.preventDefault();
        const delta = e.deltaY > 0 ? -0.1 : 0.1;
        scale = Math.min(Math.max(0.5, scale + delta), 3);
        img.style.transform = `scale(${scale}) translate(${posX}px, ${posY}px)`;
      });

      img.addEventListener('mousedown', e => {
        e.preventDefault();
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        img.style.cursor = 'grabbing';
      });

      document.addEventListener('mouseup', () => {
        isDragging = false;
        img.style.cursor = 'grab';
      });

      document.addEventListener('mousemove', e => {
        if (!isDragging) return;
        const dx = (e.clientX - startX) / scale;
        const dy = (e.clientY - startY) / scale;
        posX += dx;
        posY += dy;
        startX = e.clientX;
        startY = e.clientY;
        img.style.transform = `scale(${scale}) translate(${posX}px, ${posY}px)`;
      });

      document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
          scale = 1;
          posX = 0;
          posY = 0;
          img.style.transform = 'scale(1) translate(0, 0)';
          document.querySelectorAll('.cam-container').forEach(c => c.classList.remove('expanded', 'right-small'));
          document.querySelector('.video-area').classList.remove('alt-expanded');
        }
      });
    }

    window.onload = () => {
      setInterval(updateTimestamps, 1000);
      updateTimestamps();
      setInterval(pollWarning, 2000);
      pollWarning();
      enableFloatingPlayerDragAndResize();

      document.querySelectorAll('.cam-container img').forEach(img => {
        enablePanZoom(img);
        img.addEventListener('click', (e) => {
          if (!e.altKey) return;
          const container = img.closest('.cam-container');
          const all = document.querySelectorAll('.cam-container');
          const isExpanded = container.classList.contains('expanded');
          const videoArea = document.querySelector('.video-area');

          all.forEach(c => {
            c.classList.remove('expanded', 'right-small');
            c.style.gridColumn = '';
            c.style.gridRow = '';
          });
          videoArea.classList.remove('alt-expanded');

          if (!isExpanded) {
            container.classList.add('expanded');
            videoArea.classList.add('alt-expanded');

            const rightSmalls = [];
            all.forEach(c => {
              if (c !== container) {
                c.classList.add('right-small');
                rightSmalls.push(c);
              }
            });

            rightSmalls.forEach((e1, idx) => {
              e1.style.gridColumn = '2';
              e1.style.gridRow = `${idx + 1}`;
            });
          }
        });
      });
    };

    const socket = new WebSocket("ws://localhost:8000/ws");

   socket.onmessage = (event) => {
  console.log("[DEBUG] WebSocket received message:", event.data);  
  
  const log = JSON.parse(event.data);
  console.log("[DEBUG] Parsed log object:", log);
  
  console.log("[DEBUG] 로그 종류:", log.label);
  console.log("[DEBUG] 클립 여부:", log.clip);
  console.log("[DEBUG] 메시지 정보:", log.message);
  
  
  
  
  
  const key = `${log.cam}_${log.label}_${log.time}`;
  if (document.querySelector(`.log-entry[data-key="${key}"]`)) return;

  const div = document.createElement("div");
  div.className = "log-entry";
  div.setAttribute("data-key", key);

  if (log.label === "velocity" && log.message) {
    // ✅ 속도 로그는 하단 전용
    div.innerHTML = `
      <div><strong>${log.cam}</strong></div>
      <div>📡 ${log.message}</div>
      <div style="font-size: 12px; color: #aaa;">${log.time}</div>
    `;
    document.getElementById("bottom-log-list").prepend(div);
  }

  if ((log.label && (log.label.includes("person") || log.label.includes("animal"))) && log.clip) {
    // ✅ 감지 로그는 사이드바 표시 + avg conf 메시지 포함
    const labelEmoji = log.label === "animal" ? "🐾 animal" : "🚶 person";
    const confInfo = log.message ? `<div style="font-size: 12px; color: #ccc;">${log.message}</div>` : "";

    div.innerHTML = `
      <div><strong>${log.cam}</strong></div>
      <div>${labelEmoji}</div>
      ${confInfo}
      <div style="font-size: 12px; color: #aaa;">${log.time}</div>
    `;
    div.onclick = () => playClip(log.clip);
    document.getElementById("log-list").prepend(div);


    console.log("[DEBUG] 로그 UI에 추가 완료:", div.innerHTML);
    console.log("[DEBUG] 현재 감지 로그 개수:", document.querySelectorAll("#log-list .log-entry").length);
  }
};


    socket.onerror = (err) => {
      console.error("WebSocket 오류:", err);
    };

    function toggleMode(camId, btn) {
  const cam = document.getElementById(camId);
  const currentSrc = cam.src;
  const isRGB = currentSrc.includes("mode=rgb");
  const newMode = isRGB ? "thermal" : "rgb";

  // ✅ URL에 캐시 방지 파라미터 추가
  cam.src = `/stream/${camId}?mode=${newMode}&t=${Date.now()}`;

  
}
  </script>
    <div class="bottom-bar" id="bottomBar">
    <h3>⬆️ 속도 분석 로그</h3>
    <div id="bottom-log-list"></div>
  </div>

  <audio id="alert-sound-person" src="/static/sounds/warning.mp3" preload="auto" loop></audio>
  <audio id="alert-sound-animal" src="/static/sounds/alert_animal.mp3" preload="auto" loop></audio>

</body>
</html>
